---
title: '笔记: Design Data Intensive Applications (DDIA)'
date: 2025-10-30 15:29:54
categories:
  - dev
---

### 名人问题
我们希望设计一个twitter-like的社交应用，用户可以互相关注。每当一个用户发帖，我们希望将帖子推送给所有关注者。有两个解决方案
* 读扩散(fan-out on read): 每个客户端以一定时间向服务器轮训，执行一条SQL查询最新的、关注的人发布的帖子。写入时只需要插入到每个用户自己的发帖列表里。
* 写扩散(fan-out on write): 给每个用户建立一个时间线(物化视图/materialized view)，每当有人发帖，插入到所有用户的时间线中。读取时只需要获取这个时间线。

扇出(fan-out)这个词非常形象，描述的是每个用户的更新将会被扩散给许多人(他的关注/被关注)

轮询的方式显然是不高效的。但写扩散也存在问题。少部分名人拥有大量的订阅者，他们每次发帖的写入成本将非常高。于是我们可以结合两者：
* 对于普通用户，采用写扩散(平均来说最多也不过上百次的写入)
* 对于名人，采用读扩散
* 用户查询时，结合自己的时间线，和从名人表里查询到的新帖子(因为名人总数很少，所以这个表不会很大)，组合成最终的时间线

Remark: 这个优化实际上是基于大部分人只有少量的关注者，少部分人有大量的关注者这个事实。同时这也是一种"分摊"的策略: 把一次超级大的写入分摊给多次小的读取，和减少gc/哈希表扩容带来的STW有异曲同工之妙。



